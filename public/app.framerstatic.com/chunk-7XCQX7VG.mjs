import{a as k}from"https://app.framerstatic.com/chunk-DZJERIIY.mjs";import{Q as y,Qa as q,Zc as H,a as O,ab as G,o as V,ue as X}from"https://app.framerstatic.com/chunk-HABMTUSV.mjs";import{e as Q}from"https://app.framerstatic.com/chunk-OOEWJVJW.mjs";import{a as M,b as h}from"https://app.framerstatic.com/chunk-SARVT3TF.mjs";import{Bd as J,nc as U}from"https://app.framerstatic.com/chunk-KMAC4JUD.mjs";import{Zi as I}from"https://app.framerstatic.com/chunk-MEZTIH57.mjs";import{c as w,d as P}from"https://app.framerstatic.com/chunk-LKMP537Z.mjs";import{b as E,d as F,p as S}from"https://app.framerstatic.com/chunk-XB2V7G5R.mjs";import{g as b}from"https://app.framerstatic.com/chunk-TL2YQ7KN.mjs";import{l as g}from"https://app.framerstatic.com/chunk-XDXIFLRG.mjs";import{fa as $,j,m as B,s as R,v as z}from"https://app.framerstatic.com/chunk-WWEGIMHT.mjs";import{a as f}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{a as T}from"https://app.framerstatic.com/chunk-LQILWJHN.mjs";import{j as a}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var oe=3,d=z("PartialTreeSender"),K=j();function Y(){return new Promise((s,e)=>{if(typeof MessageChannel<"u"){let t=new MessageChannel;t.port1.onmessage=()=>s(),t.port1.onmessageerror=()=>e(),t.port2.postMessage(null)}else setTimeout(s,0)})}var Z=class{constructor(e,t,n){this.timeline=e;a(this,"name");a(this,"currentScopeId","");a(this,"timelineCursor");a(this,"scopeBufferMap",new Map);a(this,"chunkQueue",[]);a(this,"chunkIndex",0);a(this,"chunkingConfig");a(this,"drainingPromise");this.name=t+"-"+String(Math.round(Math.random()*1e3)),this.chunkingConfig={maxNodesPerChunk:n?.maxNodesPerChunk??1e3}}shouldUseChunking(e,t){if(this.timelineCursor)return!1;let n=e.chunkingHints;if(!n||n.size===0)return!1;let i=C();t&&i.add(t);for(let r of i)if(n.has(r))return d.debug(this.name,`chunking required - large page hint: ${r}`),!0;return!1}serializeTreeChunks(e,t){let n=[],i=crypto.randomUUID(),r=new Map,o=new Map,p=0,u=C();t&&u.add(t);let v=()=>{r.size>0&&(n.push({name:this.name,timestamp:Date.now(),treeChunks:{chunkId:i,chunkIndex:n.length,totalChunks:-1,nodes:r,childrenMap:o,rootId:n.length===0?e.root.id:void 0}}),r=new Map,o=new Map)},D=c=>{let N=y.valueFromNode(c);r.set(c.id,N);let ie=c.children?c.children.map(x=>x.id):[];if(o.set(c.id,ie),p++,N.children&&(N.children=K),r.size>=this.chunkingConfig.maxNodesPerChunk&&v(),c.children)for(let x of c.children)D(x)},A=e.root,m,L={};for(m in A)I[m]||(L[m]=A[m]);let _=e.getNodes(u),re={...L,__class:"RootNode",id:e.root.id,children:K};r.set(e.root.id,re),o.set(e.root.id,_.map(c=>c.id)),p++,r.size>=this.chunkingConfig.maxNodesPerChunk&&v();for(let c of _)D(c);v();let se=n.length;for(let c of n)c.treeChunks.totalChunks=se;return d.debug(this.name,`directly chunked tree into ${n.length} chunks with ${p} total nodes`),n}getNextChunk(){if(this.chunkQueue.length===0)return;let e=this.chunkQueue[this.chunkIndex];return this.chunkIndex++,this.chunkIndex>=this.chunkQueue.length&&(this.chunkQueue=[],this.chunkIndex=0),e}hasMoreChunks(){return f(this.chunkIndex>=0,"Chunk index should not be negative"),f(this.chunkIndex<=this.chunkQueue.length,"Chunk index should not exceed queue length"),this.chunkIndex<this.chunkQueue.length}async*drainChunks(e){if(!this.hasMoreChunks())return;let t=this.drainingPromise;this.drainingPromise=new $,t&&(d.debug(this.name,"drainChunks already in progress, waiting for it to finish"),await t),d.debug(this.name,"drainChunks started");let n=0,i=performance.now();try{for(;this.hasMoreChunks();){if(e?.aborted){d.debug(this.name,"drainChunks aborted, clearing chunk queue"),this.chunkQueue=[],this.chunkIndex=0;return}let r=this.getNextChunk();r&&(n++,d.debug(this.name,`sending chunk ${r.treeChunks.chunkIndex+1} of ${r.treeChunks.totalChunks}`),yield r),await Y()}}finally{await Y(),this.timelineCursor=this.timeline.getChangeTrackingCursor();let r=performance.now()-i,o=r>1e3?`${(r/1e3).toFixed(2)}s`:`${Math.round(r)}ms`;d.debug(this.name,`completed sending ${n} chunks in ${o}`),d.debug(this.name,"drainChunks completed"),this.drainingPromise?.resolve(),this.drainingPromise=void 0}}resetScopeBuffer(e){this.scopeBufferMap.clear(),this.currentScopeId=e??"",e&&(this.timelineCursor=void 0,this.scopeBufferMap.set(e,performance.now()))}updateScopeBuffer(e){if(this.currentScopeId===e)return[void 0,void 0];if(e===O)return[void 0,void 0];if(this.currentScopeId=e,this.scopeBufferMap.has(this.currentScopeId))return this.scopeBufferMap.set(this.currentScopeId,performance.now()),[void 0,void 0];let t;if(this.scopeBufferMap.size>=oe){let n=C(),i=1/0,r;for(let[o,p]of this.scopeBufferMap)n.has(o)||i>p&&(i=p,r=o);r&&(this.scopeBufferMap.delete(r),t=r)}return this.scopeBufferMap.set(this.currentScopeId,performance.now()),[t,e]}reset(e){let t=this.timeline.tree;if(this.resetScopeBuffer(e),this.shouldUseChunking(t,e))return this.chunkQueue=this.serializeTreeChunks(t,e),this.chunkIndex=0,d.debug(this.name,"initiated direct chunked transfer for tree"),null;let n=ee(t,e);return this.chunkQueue=[],this.chunkIndex=0,n}update(e){if(!e)return{};if(this.hasMoreChunks())return{};let t=this.timeline.tree,n=this.timeline.fetchForwardChanges(this.timelineCursor);if(!n){if(this.timeline.invalidatedByLoadCompletedDocument(this.timelineCursor))return d.debug(this.name,"cursor invalidated, sending empty update for load completed document"),this.timelineCursor=this.timeline.getChangeTrackingCursor(),{};if(this.resetScopeBuffer(e),this.shouldUseChunking(t,e)){this.chunkQueue=this.serializeTreeChunks(t,e),this.chunkIndex=0;let u=this.getNextChunk();if(u)return d.debug(this.name,`starting direct chunked resend with ${this.chunkQueue.length} chunks`),u}let p=ee(t,e);return d.debug(this.name,"cursor invalidated, sending tree with scope:",e),this.timelineCursor=this.timeline.getChangeTrackingCursor(),{name:this.name,tree:p,timestamp:Date.now()}}let[i,r]=this.updateScopeBuffer(e);i&&(d.debug(this.name,"deleting scope by diff:",i),W(i,n)),n.length===0&&(n=void 0);let o;if(r&&(d.debug(this.name,"adding scope by subtree:",r),o=this.getScopeSubTree(t,r)),n){let p=this.getAffectedScopeIDsAfterCrossScopeMove(t,n);for(let u of p){if(u!==this.currentScopeId){this.scopeBufferMap.has(u)&&(d.debug(this.name,"deleting scope due to cross-scope move:",u),W(u,n),this.scopeBufferMap.delete(u));continue}o||(d.debug(this.name,"resending tree with scope due to cross-scope move:",u),o=this.getScopeSubTree(t,u))}}return{changes:n,scopes:o?[o]:void 0,timestamp:Date.now()}}getScopeSubTree(e,t){let n=e.get(t);return Q(n)&&f(n.isLoaded(),"Scope must be loaded"),ae(n)}getAffectedScopeIDsAfterCrossScopeMove(e,t){let n=new Set;for(let i of t){if(!i.previousScope||!i.to.parentid)continue;let r=e.get(i.id),o=e.getScopeNodeFor(r);o&&n.add(o.id)}return n}};function W(s,e){e.push({id:s,removed:"CanvasNode",to:{}})}function ae(s){if(s)return y.valueFromNode(s)}function C(){return new Set([H,q,X,J,G,O])}function ee(s,e){let t=C();e&&t.add(e);let n=s.getNodes(t).map(p=>y.valueFromNode(p)),i=s.root,r,o={};for(r in i)I[r]||(o[r]=i[r]);return{version:V,root:{...o,__class:"RootNode",id:s.root.id,children:n}}}var l=class{constructor(e){this.callbacks=e;a(this,"experimentListeners",new Map);a(this,"employeesOnlySettingsListeners",new Map);a(this,"projectFeaturesListeners",new Map)}startUpdatesStream(){Object.keys(F).forEach(e=>{let t=n=>{this.callbacks.updateExperiments({[e]:n})};S.addListener(e,t),this.experimentListeners.set(e,t)}),Object.keys(E).forEach(e=>{let t=n=>{this.callbacks.updateEmployeesOnlySettings({[e]:n})};k.addListener(e,t),this.employeesOnlySettingsListeners.set(e,t)})}getInitialExperiments(){let e={};return Object.keys(F).forEach(t=>{e[t]=S.get(t)}),e}getInitialEmployeesOnlySettings(){let e={};return Object.keys(E).forEach(t=>{e[t]=k.get(t)}),e}initProjectFeatures(){h.updated.then(()=>{let e={};Object.keys(M).forEach(t=>{e[t]=h.get(t)}),this.callbacks.updateProjectFeatures(e),this.projectFeaturesListeners.size===0&&Object.keys(M).forEach(t=>{let n=i=>{this.callbacks.updateProjectFeatures({[t]:i})};h.addListener(t,n),this.projectFeaturesListeners.set(t,n)})}).catch(B)}stopUpdatesStream(){for(let[e,t]of this.experimentListeners)S.removeListener(e,t);for(let[e,t]of this.employeesOnlySettingsListeners)k.removeListener(e,t);for(let[e,t]of this.projectFeaturesListeners)h.removeListener(e,t);this.experimentListeners.clear(),this.employeesOnlySettingsListeners.clear(),this.projectFeaturesListeners.clear()}},te=class{constructor(e){this.remoteFlags=e;let t=new l(this.remoteFlags);t.startUpdatesStream(),this.remoteFlags.updateExperiments(t.getInitialExperiments()),this.remoteFlags.updateEmployeesOnlySettings(t.getInitialEmployeesOnlySettings())}};var De=R({canvas:()=>{let s=de();return P(s),w(s)},onPageCanvas:()=>{let s=ue();return P(s),w(s)}});function de(){let s=b.isDebugBuild?"canvas-sandbox.debug.html":"canvas-sandbox.html",e=U(`./${s}`),t=JSON.stringify(T());return e+`#services=${encodeURIComponent(t)}`}function ue(){let s=b.isDebugBuild?"canvas-sandbox-on-page.debug.html":"canvas-sandbox-on-page.html",e=U(`./${s}`),t=JSON.stringify(T());return e+`#services=${encodeURIComponent(t)}`}var ne=class{constructor(){a(this,"experimentsUpdatesEmitter",new g);a(this,"employeesOnlySettingsUpdatesEmitter",new g);a(this,"projectFeaturesUpdatesEmitter",new g);a(this,"flagsUpdater",new l(this));this.flagsUpdater.startUpdatesStream(),this.experimentsUpdatesEmitter.onNewStream=e=>{if(e?.replay==="latest")return{latest:this.flagsUpdater.getInitialExperiments()}},this.employeesOnlySettingsUpdatesEmitter.onNewStream=e=>{if(e?.replay==="latest")return{latest:this.flagsUpdater.getInitialEmployeesOnlySettings()}},this.projectFeaturesUpdatesEmitter.onNewStream=e=>{this.flagsUpdater.initProjectFeatures()}}updateExperiments(e){this.experimentsUpdatesEmitter.emit(e)}updateEmployeesOnlySettings(e){this.employeesOnlySettingsUpdatesEmitter.emit(e)}updateProjectFeatures(e){this.projectFeaturesUpdatesEmitter.emit(e)}stopUpdatesStream(){this.flagsUpdater.stopUpdatesStream()}experimentsUpdatesStream(e){return this.experimentsUpdatesEmitter.newStream(e)}employeesOnlySettingsUpdatesStream(e){return this.employeesOnlySettingsUpdatesEmitter.newStream(e)}projectFeaturesUpdatesStream(e){return this.projectFeaturesUpdatesEmitter.newStream(e)}};export{te as a,ne as b,De as c,Z as d};
//# sourceMappingURL=https://app.framerstatic.com/chunk-7XCQX7VG.mjs.map
